

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SQL - Part 2: Advanced Features &mdash; dbms  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="SQL - Part 3: Data Definition and Manipulation" href="sql_dmlddl.html" />
    <link rel="prev" title="SQL - Part 1: Basics" href="sql_basics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> dbms
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Answered Questions for Database Systems</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">CSCI 4380 Database Systems - Fall 2020</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../course_notes.html">Course notes</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro.html">Introduction to Relational Databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="dbs_example.html">Example Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="relational_algebra.html">Relational Model and Algebra</a></li>
<li class="toctree-l3"><a class="reference internal" href="normalization.html">Normalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="er.html">Entity-Relationship (ER) Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql_basics.html">SQL - Part 1: Basics</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">SQL - Part 2: Advanced Features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#outer-join">Outer Join</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inner-vs-outer-join">Inner vs. outer join.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#anonymous-relations">Anonymous relations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scalar-queries">Scalar Queries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#comparisons-involving-sets-bags">Comparisons involving sets/bags</a></li>
<li class="toctree-l4"><a class="reference internal" href="#set-comparison-operators">Set Comparison Operators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#correlated-subqueries">Correlated Subqueries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#for-all-queries">FOR ALL Queries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#with-statement-newer-form-of-anonymous-relations">WITH Statement (newer form of anonymous relations)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="sql_dmlddl.html">SQL - Part 3: Data Definition and Manipulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql_procedural.html">SQL - Procedural Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql_procedural2.html">SQL - Embedded SQL Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="or_frameworks.html">SQL - Object-Relational Frameworks</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql_otherfeatures.html">SQL - Other Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="sql_objectrelational.html">SQL - Object-Relational Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="secondary_storage.html">Secondary Storage and Indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="query_processing.html">Query Processing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../schedule.html">Detailed course schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../recordings.html">Lecture Recordings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#external-links">External links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#review-sessions-and-office-hours">Review Sessions and Office Hours</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#teaching-staff">Teaching Staff</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#indices-and-tables">Indices and tables</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dbms</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">CSCI 4380 Database Systems - Fall 2020</a> &raquo;</li>
        
          <li><a href="../course_notes.html">Course Notes - Fall 2020</a> &raquo;</li>
        
      <li>SQL - Part 2: Advanced Features</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/fall2020/course_notes/sql_advanced.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sql-part-2-advanced-features">
<h1>SQL - Part 2: Advanced Features<a class="headerlink" href="#sql-part-2-advanced-features" title="Permalink to this headline">¶</a></h1>
<ul>
<li><p>In this lecture, we will learn more advanced features of SQL.</p></li>
<li><p>Examples database to be used in this lecture is given in SQL here:</p>
<p>See <code class="xref download docutils literal notranslate"><span class="pre">example</span> <span class="pre">database</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">used</span></code>.</p>
</li>
</ul>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Remember that while SQL is a standard, there are still differences
in implementations of it.</p>
<ul>
<li><p>Writing queries that do not rely on specific features results in
portable applications.</p></li>
<li><p>However, you cannot deny that some constructs may simplify your
queries and performance. So, it is important to decide when to use
a specific method to write a query.</p></li>
</ul>
</li>
<li><p>Remember: a query is not an algorithm. It is for the most part
a logical statement of what you are interested in.</p>
<ul>
<li><p>Often, there are multiple algorithms to implement it.</p></li>
<li><p>Most DBMSs feature state of the art query optimizers (QOPT) that
choose the lowest cost algorithm for a given query and database.</p></li>
<li><p>QOPT engines are very sophisticated, often operate better than
even expert human judgment.</p></li>
<li><p>So, instead of trying to optimize your queries,
you can try to make your queries easy to optimize: simple queries
are better.</p></li>
</ul>
</li>
<li><p>Once you become sophisticated in a specific DBMS, you may learn
specific weaknesses and you can develop strategies to adopt for
that. We will discuss some.</p></li>
<li><p>Finally, you should still follow some very simple guidelines:</p>
<ul>
<li><p>Do not join with a relation if it is not needed for your query.</p></li>
<li><p>Do not sort (order by) or remove duplicates (distinct) unless it
is necessary.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="outer-join">
<h2>Outer Join<a class="headerlink" href="#outer-join" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A INNER JOIN B: inner join selects tuples that satisfy a join condition,
eliminates all tuples that do not satisfy the join condition. A is
called the left operand and B is the right operand of the join
operation.</p></li>
<li><p>A LEFT OUTER JOIN B returns all tuples in the inner join as well as
the tuples in A that do not join with any tuples in in B.</p></li>
<li><p>A RIGHT OUTER JOIN B returns all tuples in the inner join as well as
the tuples in B that do not join with any tuples in in A.</p></li>
<li><p>A FULL OUTER JOIN B returns all tuples in the inner join as well as
the tuples from A and B that do not participate in the inner join.</p>
<ul>
<li><p>You can also use terms: JOIN, LEFT JOIN, RIGHT JOIN, FULL JOIN</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="inner-vs-outer-join">
<h2>Inner vs. outer join.<a class="headerlink" href="#inner-vs-outer-join" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Given R(A,B) and S(B,C) with the following contents:</p></li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>a1</p></td>
<td><p>b1</p></td>
</tr>
<tr class="row-odd"><td><p>a2</p></td>
<td><p>b2</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>b1</p></td>
<td><p>c1</p></td>
</tr>
<tr class="row-odd"><td><p>b3</p></td>
<td><p>c3</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p>We get the following results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">R</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">C</span>
<span class="n">FROM</span> <span class="n">R</span> <span class="n">JOIN</span> <span class="n">S</span> <span class="n">ON</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>a1</p></td>
<td><p>b1</p></td>
<td><p>b1</p></td>
<td><p>c1</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">R</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">C</span>
<span class="n">FROM</span> <span class="n">R</span> <span class="n">LEFT</span> <span class="n">JOIN</span> <span class="n">S</span> <span class="n">ON</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>a1</p></td>
<td><p>b1</p></td>
<td><p>b1</p></td>
<td><p>c1</p></td>
</tr>
<tr class="row-odd"><td><p>a2</p></td>
<td><p>b2</p></td>
<td><p>null</p></td>
<td><p>null</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">R</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">C</span>
<span class="n">FROM</span> <span class="n">R</span> <span class="n">RIGHT</span> <span class="n">JOIN</span> <span class="n">S</span> <span class="n">ON</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>a1</p></td>
<td><p>b1</p></td>
<td><p>b1</p></td>
<td><p>c1</p></td>
</tr>
<tr class="row-odd"><td><p>null</p></td>
<td><p>null</p></td>
<td><p>b3</p></td>
<td><p>c3</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">R</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">C</span>
<span class="n">FROM</span> <span class="n">R</span> <span class="n">FULL</span> <span class="n">JOIN</span> <span class="n">S</span> <span class="n">ON</span> <span class="n">R</span><span class="o">.</span><span class="n">B</span><span class="o">=</span><span class="n">S</span><span class="o">.</span><span class="n">B</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>A</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>C</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>a1</p></td>
<td><p>b1</p></td>
<td><p>b1</p></td>
<td><p>c1</p></td>
</tr>
<tr class="row-odd"><td><p>a2</p></td>
<td><p>b2</p></td>
<td><p>null</p></td>
<td><p>null</p></td>
</tr>
<tr class="row-even"><td><p>null</p></td>
<td><p>null</p></td>
<td><p>b3</p></td>
<td><p>c3</p></td>
</tr>
</tbody>
</table>
</li>
<li><p>We can use the fact that tuples that do not match have
null values for the join.</p></li>
</ul>
<div class="section" id="outer-join-examples">
<h3>Outer join examples:<a class="headerlink" href="#outer-join-examples" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>For each baker, find the total number of times they were a favorite.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">baker</span><span class="p">)</span> <span class="k">as</span> <span class="n">numfavorites</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
      <span class="n">left</span> <span class="n">join</span> <span class="n">favorites</span> <span class="n">f</span>
      <span class="n">on</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">baker</span>
<span class="n">GROUP</span> <span class="n">BY</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="p">;</span>
</pre></div>
</div>
<p>For bakers with no favorite tuples, f.baker will be null. So, when
we count f.baker values, the count will be zero for these
bakers.</p>
<p>If we used inner join, we would have elimited all bakers with
zero favorite tuples as they would not join with favorites.</p>
</li>
<li><p>Find bakers who were never a favorite.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">SELECT</span>
     <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
  <span class="n">FROM</span>
     <span class="n">bakers</span> <span class="n">b</span>
        <span class="n">left</span> <span class="n">join</span> <span class="n">favorites</span> <span class="n">f</span>
        <span class="n">on</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">baker</span>
  <span class="n">WHERE</span>
     <span class="n">f</span><span class="o">.</span><span class="n">baker</span> <span class="n">IS</span> <span class="n">NULL</span><span class="p">;</span>


<span class="n">This</span> <span class="n">works</span> <span class="n">because</span> <span class="k">if</span> <span class="n">a</span> <span class="n">baker</span> <span class="n">has</span> <span class="n">no</span> <span class="n">matching</span> <span class="nb">tuple</span> <span class="ow">in</span> <span class="n">favorites</span><span class="p">,</span>
<span class="n">then</span> <span class="n">the</span> <span class="n">f</span><span class="o">.</span><span class="n">baker</span> <span class="n">attribute</span> <span class="n">would</span> <span class="n">be</span> <span class="n">null</span><span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>For each baker, find how many times they won the technical challenge.</p>
<p>Note that we would like to use left join as in the previous case,
but not with the whole technicals table but only the tuples where
rank is 1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span> <span class="k">as</span> <span class="n">numwins</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
      <span class="n">left</span> <span class="n">join</span> <span class="n">technicals</span> <span class="n">t</span>
      <span class="n">on</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">baker</span>
         <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">GROUP</span> <span class="n">BY</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="anonymous-relations">
<h2>Anonymous relations<a class="headerlink" href="#anonymous-relations" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>A query can be treated like a relation in the from clause</p>
<p>It is treated like a virtual relation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">t</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span> <span class="k">as</span> <span class="n">numtophalf</span>
<span class="n">FROM</span>
   <span class="p">(</span> <span class="n">SELECT</span>
         <span class="n">episodeid</span>
         <span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">numbakers</span>
     <span class="n">FROM</span>
         <span class="n">technicals</span>
     <span class="n">GROUP</span> <span class="n">BY</span>
         <span class="n">episodeid</span>
   <span class="p">)</span> <span class="k">as</span> <span class="n">epnum</span>
   <span class="p">,</span> <span class="n">technicals</span> <span class="n">t</span>
<span class="n">WHERE</span>
   <span class="n">t</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">epnum</span><span class="o">.</span><span class="n">episodeid</span>
   <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">rank</span> <span class="o">&lt;</span> <span class="n">epnum</span><span class="o">.</span><span class="n">numbakers</span><span class="o">/</span><span class="mi">2</span>
<span class="n">GROUP</span> <span class="n">BY</span>
   <span class="n">t</span><span class="o">.</span><span class="n">baker</span> <span class="p">;</span>
</pre></div>
</div>
<p>The inner query allows us to find how many bakers competed in each
episode. We can then use this information in the main query as if it
was a real relation, and find how many times a baker performed in
the top half of the technical challenges.</p>
<p>This query would not be possible to write without an anonymous
relation as we cannot count for different types of things (bakers
for episodes and episodes for bakers) with a single group by.</p>
</li>
<li><p>Find the maximum number of people eliminated in an episode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">numeliminated</span><span class="p">)</span>
<span class="n">FROM</span>
    <span class="p">(</span><span class="n">SELECT</span> <span class="o">--</span> <span class="n">number</span> <span class="n">of</span> <span class="n">people</span> <span class="n">eliminated</span> <span class="ow">in</span> <span class="n">each</span> <span class="n">episode</span>
        <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">numeliminated</span>
     <span class="n">FROM</span>
        <span class="n">results</span>
     <span class="n">WHERE</span>
        <span class="n">result</span><span class="o">=</span><span class="s1">&#39;eliminated&#39;</span>
     <span class="n">GROUP</span> <span class="n">BY</span>
        <span class="n">episodeid</span>
     <span class="p">)</span> <span class="k">as</span> <span class="n">elim</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Be careful: Do not use any anonymous relations to make it
simpler to write/read the query.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">S</span><span class="o">.</span><span class="n">d</span>
<span class="n">FROM</span>
   <span class="p">(</span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.*</span> <span class="n">FROM</span> <span class="n">R</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">newR</span>
   <span class="p">,</span> <span class="n">S</span>
<span class="n">WHERE</span>
   <span class="n">S</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">newR</span><span class="o">.</span><span class="n">c</span><span class="p">;</span>
</pre></div>
</div>
<p>Anonymous relation is not really necessary here. The same query
can be written with a simple join:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">S</span><span class="o">.</span><span class="n">d</span> <span class="n">FROM</span> <span class="n">R</span><span class="p">,</span><span class="n">S</span> <span class="n">WHERE</span> <span class="n">R</span><span class="o">.</span><span class="n">b</span><span class="o">&gt;</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">S</span><span class="o">.</span><span class="n">c</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">c</span><span class="p">;</span>
</pre></div>
</div>
<p>When using an anonymous view, query optimizer may miss certain
optimizations, especially in older DBMS.</p>
</li>
</ul>
</div>
<div class="section" id="scalar-queries">
<h2>Scalar Queries<a class="headerlink" href="#scalar-queries" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Any query that returns a single number with an aggregate function
is called a scalar query.</p>
<p>You can use a scalar query as if it was a number. We first find the
biggest drop in ratings between two episodes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="nb">max</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span><span class="p">)</span>
<span class="n">FROM</span>
   <span class="n">episodes</span> <span class="n">e1</span>
   <span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span>
<span class="n">WHERE</span>
   <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

<span class="nb">max</span>
<span class="o">-------</span>
<span class="mf">0.84</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we find who was eliminated in this episode (or episodes if
there is more than one with the same drop):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">r</span><span class="o">.</span><span class="n">baker</span>
<span class="n">FROM</span>
   <span class="n">episodes</span> <span class="n">e1</span>
   <span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span>
   <span class="p">,</span> <span class="n">results</span> <span class="n">r</span>
<span class="n">WHERE</span>
   <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span>
   <span class="ow">and</span> <span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span> <span class="o">=</span> <span class="mf">0.84</span>
   <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span>
   <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span><span class="p">;</span>

<span class="n">baker</span>
<span class="o">--------</span>
<span class="n">Briony</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>We can write the same query by simply substituting the first query
for the constant 0.84:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">r</span><span class="o">.</span><span class="n">baker</span>
<span class="n">FROM</span>
   <span class="n">episodes</span> <span class="n">e1</span>
   <span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span>
   <span class="p">,</span> <span class="n">results</span> <span class="n">r</span>
<span class="n">WHERE</span>
   <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span>
   <span class="ow">and</span> <span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span> <span class="o">=</span>
                    <span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span><span class="p">)</span>
                     <span class="n">FROM</span> <span class="n">episodes</span> <span class="n">e1</span><span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span> <span class="n">WHERE</span> <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
   <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span>
   <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="comparisons-involving-sets-bags">
<h2>Comparisons involving sets/bags<a class="headerlink" href="#comparisons-involving-sets-bags" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Many expressions in the WHERE clause (or HAVING) can compare a
value against a SET</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WHERE</span> <span class="n">hometown</span> <span class="n">IN</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">,</span><span class="s1">&#39;Bristol&#39;</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="n">baker</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span><span class="s1">&#39;Imelda&#39;</span><span class="p">,</span><span class="s1">&#39;Luke&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Substitute a query for the set: Find bakers who were never eliminated.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">baker</span>
   <span class="p">,</span> <span class="n">fullname</span>
<span class="n">FROM</span>
   <span class="n">bakers</span>
<span class="n">WHERE</span>
   <span class="n">baker</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span><span class="n">SELECT</span> <span class="n">baker</span> <span class="n">FROM</span> <span class="n">results</span> <span class="n">WHERE</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>You can write equivalent queries using EXCEPT and LEFT JOIN.</p></li>
</ul>
</div>
<div class="section" id="set-comparison-operators">
<h2>Set Comparison Operators<a class="headerlink" href="#set-comparison-operators" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>There are many set comparison operators that can be used in
queries. The inner query must return a single column for this to
work.</p>
<p>Some useful operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">value</span> <span class="n">IN</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>
<span class="n">value</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>
<span class="n">value</span> <span class="o">&gt;</span> <span class="n">ANY</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>
<span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ALL</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>
<span class="n">value</span> <span class="o">&gt;</span> <span class="n">ALL</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">ANY</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>   <span class="o">--&gt;</span> <span class="n">same</span> <span class="k">as</span> <span class="n">IN</span>
<span class="n">value</span> <span class="o">&lt;&gt;</span> <span class="n">ALL</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span>  <span class="o">--&gt;</span> <span class="n">same</span> <span class="k">as</span> <span class="n">NOT</span> <span class="n">IN</span>
</pre></div>
</div>
</li>
<li><p>You can also write expressions that check whether a query returns
any tuples at all:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EXISTS</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">Query</span> <span class="n">returns</span> <span class="n">at</span> <span class="n">least</span> <span class="n">one</span> <span class="nb">tuple</span>
<span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">(</span><span class="n">QUERY</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">Query</span> <span class="n">returns</span> <span class="n">no</span> <span class="n">tuples</span>
</pre></div>
</div>
</li>
<li><p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span> <span class="n">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>       <span class="n">FALSE</span>
<span class="mi">5</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>   <span class="n">TRUE</span>
<span class="mi">2</span> <span class="n">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>       <span class="n">TRUE</span>
<span class="n">EXISTS</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>     <span class="n">TRUE</span>
<span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="n">FALSE</span>
<span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">()</span>        <span class="n">TRUE</span>
<span class="mi">5</span> <span class="o">&lt;</span><span class="n">ALL</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>     <span class="n">FALSE</span>
<span class="mi">5</span> <span class="o">&gt;</span><span class="n">ALL</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>     <span class="n">TRUE</span>
</pre></div>
</div>
</li>
<li><p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
    <span class="o">*</span>
<span class="n">FROM</span>
    <span class="n">bakers</span>
<span class="n">WHERE</span>
    <span class="n">EXISTS</span> <span class="p">(</span><span class="n">SELECT</span> <span class="mi">1</span>
            <span class="n">FROM</span> <span class="n">signatures</span>
            <span class="n">WHERE</span> <span class="n">lower</span><span class="p">(</span><span class="n">make</span><span class="p">)</span> <span class="n">LIKE</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">ardamom%&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>This is a kind of stupid query: if there is any make with cardamom,
we will return all bakers. Otherwise, we return no students.</p>
</li>
<li><p>Since it does not matter what we return in EXISTS/NOT EXISTS
conditions (we only care whether a tuple is returned or not), we
can return something simple like an integer, instead of a
relation column.</p></li>
</ul>
</div>
<div class="section" id="correlated-subqueries">
<h2>Correlated Subqueries<a class="headerlink" href="#correlated-subqueries" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>More interesting queries involve correlated subqueries.</p></li>
<li><p>Find bakers who never won a technical challenge:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
    <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
    <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">FROM</span>
    <span class="n">bakers</span> <span class="n">b</span>
<span class="n">WHERE</span>
    <span class="n">NOT</span> <span class="n">EXISTS</span>
    <span class="p">(</span> <span class="n">SELECT</span> <span class="mi">1</span> <span class="n">FROM</span> <span class="n">technicals</span> <span class="n">t</span> <span class="n">WHERE</span> <span class="n">t</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">rank</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span> <span class="p">;</span>
</pre></div>
</div>
<p>For each baker tuple b, execute the inner subquery to find all
technical tuples for this baker with rank 1. If there is no such
tuple, then return tuple b.</p>
<ul class="simple">
<li><p>Outer query: bakers b</p></li>
<li><p>Inner query: technicals t</p></li>
</ul>
</li>
<li><p>Scope of variables:</p>
<ul class="simple">
<li><p>The inner query can reference any tuple value in the outer query
(from the FROM clause), treating these values as constants for
the inner query.</p></li>
<li><p>The outer query cannot access the variables of the inner query.</p></li>
<li><p>If the iner query rewrites an alias from the outer query, then
the closest definition is used.</p></li>
</ul>
</li>
</ul>
<div class="section" id="common-mistake-when-using-a-nested-subquery">
<h3>Common mistake when using a nested subquery<a class="headerlink" href="#common-mistake-when-using-a-nested-subquery" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Rewrite your own alias in the inner subquery</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
<span class="n">WHERE</span>
   <span class="n">NOT</span> <span class="n">EXISTS</span>
   <span class="p">(</span> <span class="n">SELECT</span> <span class="mi">1</span> <span class="n">FROM</span> <span class="n">technicals</span> <span class="n">t</span><span class="p">,</span> <span class="n">bakers</span> <span class="n">b</span>
     <span class="n">WHERE</span> <span class="n">t</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">rank</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span> <span class="p">;</span>
</pre></div>
</div>
<p>This query will return a very different result than the correct
query as inner baker b overwrites the outer baker b.</p>
<p>For each baker tuple, execute the inner query independently.  If it
returns no tuples, return the baker tuple. Hence: this will return
no baker tuples as there is at least one tuple in the inner query.</p>
</li>
</ul>
</div>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Find bakers who won at least 3 technical challenges:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
<span class="n">WHERE</span>
   <span class="mi">1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">technicals</span> <span class="n">t</span>
         <span class="n">WHERE</span> <span class="n">t</span><span class="o">.</span><span class="n">baker</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that while this is a correct query, it is likely more
efficient to use a group by statement for the same purpose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
     <span class="n">LEFT</span> <span class="n">JOIN</span> <span class="n">technicals</span> <span class="n">t</span>
     <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">baker</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">rank</span><span class="o">=</span><span class="mi">1</span>
<span class="n">GROUP</span> <span class="n">BY</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">HAVING</span>
   <span class="n">count</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">baker</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><p>Be careful: the query would not be correct without a left join. Why?</p>
</div></blockquote>
<ul>
<li><p>Scalar queries can also be correlated (though use this as a last
resort as well):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">e</span><span class="o">.</span><span class="n">id</span>
   <span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">numeliminated</span>
   <span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">favorites</span> <span class="n">f</span> <span class="n">WHERE</span> <span class="n">f</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
     <span class="k">as</span> <span class="n">numfavorites</span>
<span class="n">FROM</span>
   <span class="n">episodes</span> <span class="n">e</span>
   <span class="p">,</span> <span class="n">results</span> <span class="n">r</span>
<span class="n">WHERE</span>
   <span class="n">e</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span>
   <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span>
<span class="n">GROUP</span> <span class="n">BY</span>
   <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
</pre></div>
</div>
<p>Remember: this is not likely an efficient way to write this
query. Can you write the same query without a correlated subquery in
SELECT?</p>
</li>
</ul>
</div>
</div>
<div class="section" id="id1">
<h2>Examples<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>We will finish section with a few complex queries.</p>
<p>Suppose we wanted to find if a baker did not compete in a specific
episode. We would need find when they were eliminated and then see
if there was an episode before their elimination in which there was
no tuple for them competing in one of the challenges.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">DISTINCT</span>
    <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
    <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
    <span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span>
<span class="n">FROM</span>
    <span class="n">results</span> <span class="n">r</span>
   <span class="p">,</span> <span class="n">bakers</span> <span class="n">b</span>
   <span class="p">,</span> <span class="n">episodes</span> <span class="n">e</span>
<span class="n">WHERE</span>
   <span class="n">r</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span>
   <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span>  <span class="o">--</span> <span class="n">an</span> <span class="n">episode</span> <span class="n">before</span> <span class="n">they</span> <span class="n">were</span> <span class="n">eliminated</span>
   <span class="n">AND</span> <span class="n">NOT</span> <span class="n">EXISTS</span>
       <span class="p">(</span><span class="n">SELECT</span> <span class="mi">1</span> <span class="n">FROM</span> <span class="n">signatures</span> <span class="n">s</span>
        <span class="n">WHERE</span>  <span class="n">s</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Since we can find the absence of a tuple with left join too, how
about we look for an alternate way to write this query with left
join. But we need to be careful to set the relation carefully that
will left join. Here is one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">DISTINCT</span>
    <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
    <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
    <span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span>
<span class="n">FROM</span>
    <span class="n">bakers</span> <span class="n">b</span> <span class="n">join</span> <span class="n">results</span> <span class="n">r</span>
      <span class="n">on</span> <span class="n">r</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="s1">&#39;eliminated&#39;</span>
      <span class="n">join</span> <span class="n">episodes</span> <span class="n">e</span>
         <span class="n">on</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span>
         <span class="n">left</span> <span class="n">join</span> <span class="n">signatures</span> <span class="n">s</span>
            <span class="n">on</span> <span class="n">s</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
<span class="n">WHERE</span>
    <span class="n">s</span><span class="o">.</span><span class="n">baker</span> <span class="ow">is</span> <span class="n">null</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="for-all-queries">
<h2>FOR ALL Queries<a class="headerlink" href="#for-all-queries" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>What is we wanted to find bakers who competed in all the episodes of
the show.</p></li>
<li><p>This is a complex query: we want to check that the set of all
episodes that the baker competed in is equal to the set of all
episodes that exist.</p>
<p>In relational algebra, this query would need two set subtractions.</p>
<p>We can represent this query logically as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Find</span> <span class="n">bakers</span> <span class="n">who</span> <span class="n">competed</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">episodes</span><span class="p">:</span>

<span class="n">Find</span> <span class="n">bakers</span> <span class="n">b</span> <span class="n">such</span> <span class="n">that</span>
     <span class="n">there</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span> <span class="n">an</span> <span class="n">episode</span> <span class="n">e</span> <span class="n">such</span> <span class="n">that</span>
          <span class="n">b</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">take</span> <span class="n">compete</span> <span class="ow">in</span> <span class="n">episode</span> <span class="n">e</span>
          <span class="p">(</span><span class="ow">or</span> <span class="n">there</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">a</span> <span class="nb">tuple</span> <span class="ow">in</span> <span class="n">signatures</span> <span class="p">(</span><span class="ow">or</span> <span class="n">showstoppers</span> <span class="ow">or</span> <span class="n">technicals</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">b</span> <span class="ow">and</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>SQL query will also require two subqueries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
<span class="n">WHERE</span>
   <span class="n">NOT</span> <span class="n">EXISTS</span>
      <span class="p">(</span><span class="n">SELECT</span> <span class="mi">1</span>
       <span class="n">FROM</span> <span class="n">episodes</span> <span class="n">e</span>
       <span class="n">WHERE</span> <span class="n">NOT</span> <span class="n">EXISTS</span>
             <span class="p">(</span><span class="n">SELECT</span> <span class="mi">1</span>
              <span class="n">FROM</span>
                  <span class="n">signatures</span> <span class="n">s</span>
              <span class="n">WHERE</span>
                  <span class="n">s</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span>
                  <span class="n">AND</span> <span class="n">s</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">baker</span><span class="p">));</span>
</pre></div>
</div>
</li>
<li><p>Do we really need this level of complexity? Can we do this
using a count?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Return</span> <span class="n">each</span> <span class="n">baker</span> <span class="k">if</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">different</span>
<span class="n">episodes</span> <span class="n">they</span> <span class="n">competed</span> <span class="ow">in</span> <span class="ow">is</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span>
<span class="n">of</span> <span class="n">different</span> <span class="n">episodes</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">database</span><span class="o">.</span>
</pre></div>
</div>
<p>Let’s write this expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">FROM</span>
   <span class="n">bakers</span> <span class="n">b</span>
   <span class="p">,</span> <span class="n">signatures</span> <span class="n">s</span>
<span class="n">WHERE</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">baker</span>
<span class="n">GROUP</span> <span class="n">BY</span>
   <span class="n">b</span><span class="o">.</span><span class="n">baker</span>
   <span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fullname</span>
<span class="n">HAVING</span>
   <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">episodes</span><span class="p">)</span> <span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Not only this query is simpler to write, it is likely much more
efficient given it has no correlated subqueries.</p></li>
</ul>
</div>
<div class="section" id="with-statement-newer-form-of-anonymous-relations">
<h2>WITH Statement (newer form of anonymous relations)<a class="headerlink" href="#with-statement-newer-form-of-anonymous-relations" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Postgresql implements the WITH statement, part of SQL standard. In
its simplest form, WITH acts like anonymous relations. But in
reality it can do a lot more.</p></li>
<li><p>The following is the identical query from above written using
WITH clause:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">maxdrop</span> <span class="n">AS</span>
  <span class="p">(</span> <span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span><span class="p">)</span> <span class="k">as</span> <span class="n">drop</span>
    <span class="n">FROM</span> <span class="n">episodes</span> <span class="n">e1</span><span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span> <span class="n">WHERE</span> <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
 <span class="n">SELECT</span>
     <span class="n">r</span><span class="o">.</span><span class="n">baker</span>
 <span class="n">FROM</span>
     <span class="n">episodes</span> <span class="n">e1</span>
     <span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span>
     <span class="p">,</span> <span class="n">results</span> <span class="n">r</span>
     <span class="p">,</span> <span class="n">maxdrop</span> <span class="n">m</span>
 <span class="n">WHERE</span>
     <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span>
     <span class="ow">and</span> <span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">drop</span>
     <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span>
     <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>However, anonymous relations can only be used in FROM  while
relations generated using WITH can be used in any SQL statement,
including in subsequent WITH statements.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">dropval</span> <span class="n">AS</span>
<span class="p">(</span> <span class="n">SELECT</span>
      <span class="n">e1</span><span class="o">.</span><span class="n">id</span>
      <span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">viewers7day</span><span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">viewers7day</span><span class="p">)</span> <span class="k">as</span> <span class="n">drop</span>
  <span class="n">FROM</span>
      <span class="n">episodes</span> <span class="n">e1</span>
      <span class="p">,</span> <span class="n">episodes</span> <span class="n">e2</span>
  <span class="n">WHERE</span>
      <span class="n">e2</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span>
  <span class="n">GROUP</span> <span class="n">BY</span>
      <span class="n">e1</span><span class="o">.</span><span class="n">id</span> <span class="p">),</span>
 <span class="n">maxdropval</span> <span class="n">AS</span>
 <span class="p">(</span> <span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span> <span class="k">as</span> <span class="n">maxdrop</span> <span class="n">FROM</span> <span class="n">dropval</span><span class="p">)</span>
 <span class="n">SELECT</span>
     <span class="n">r</span><span class="o">.</span><span class="n">baker</span>
 <span class="n">FROM</span>
    <span class="n">results</span> <span class="n">r</span>
    <span class="p">,</span> <span class="n">dropval</span> <span class="n">d</span>
    <span class="p">,</span> <span class="n">maxdropval</span> <span class="n">m</span>
 <span class="n">WHERE</span>
    <span class="n">r</span><span class="o">.</span><span class="n">episodeid</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span>
    <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;eliminated&#39;</span>
    <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">maxdrop</span> <span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>In this case, <cite>maxdropval</cite> is referring to a query above it in the
WITH statemnt. You cannot do this in anonymous queries. Even though
<cite>maxdropval</cite> builds on <cite>dropval</cite>, you can use both in the FROM
statement below.</p></li>
<li><p>While WITH statement is quite powerful as a construct, be very
careful to use it only if is helps you write a query that is
cumbersome or very ineffecient to write using regular SQL. You can
do this by checking the cost of different queries. Find the cost of
queries by using cost estimators or by load testing and check if it
results in cost savings.</p>
<p>Do not allow the WITH statements to make SQL more procedural, this
may result in the optimizer missing some crucial query
optimizations.</p>
</li>
<li><p>We will reexamine WITH when we look at advanced SQL features.</p></li>
</ul>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Most queries that use IN or EXISTS can be rewritten using simple
joins. Joins are much easier to optimize.</p></li>
<li><p>Set subtraction usually can be expressed using NOT IN or NOT EXISTS.</p></li>
<li><p>Using anonymous relations in the from clause may cause the optimizer
to miss some optimizations. Simpler the query, the better it is.</p></li>
<li><p>There is a subtle difference on the syntax of the two statements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Attribute</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span><span class="n">select</span> <span class="n">statement</span><span class="p">)</span>
<span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">(</span><span class="n">select</span> <span class="n">statement</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>For all queries usually require two NOT EXISTS.</p></li>
<li><p>SQL aggregates and outer joins are powerful constructs for
formulating complex queries, even those involving some sort of
negation.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="sql_dmlddl.html" class="btn btn-neutral float-right" title="SQL - Part 3: Data Definition and Manipulation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sql_basics.html" class="btn btn-neutral float-left" title="SQL - Part 1: Basics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, sibel

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>